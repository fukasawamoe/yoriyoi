<main class="m-10" style="background: #ffe6e8; padding: 20px; border: 2px dashed #ffb6c1; box-shadow: 0 0 0 5px #ffe6e8; -moz-box-shadow: 0 0 0 5px #ffe6e8; -webkit-box-shadow: 0 0 0 5px #ffe6e8; font-size: 100%;">
  <%= form_with(model: schedule, local: true) do |f| %>
    <%= render 'shared/error_messages', object: f.object %>
    <div class="lg:w-1/2 md:w-2/3 mx-auto">
      <div class="m-10 flex flex-col md:justify-center lg:flex-row">
        <%= f.text_field :name, placeholder: "スケジュール名", class:'rounded w-auto py-2 justify-center lg:my-2' %>
        <div class="flex flex-col-reverse lg:flex-row">
          <div class="flex lg:mx-auto">
            <% ['日', '月', '火', '水', '木', '金', '土'].each_with_index do |day, index| %>
              <div class="my-4 md:px-4 md:mx-auto mx-auto flex flex-col md:flex-row items-center">
                <%= check_box_tag 'schedule[day_of_week][]', index, schedule.day_of_week.include?(index), class: 'rounded' %>
                <%= day %>
              </div>
            <% end %>
          </div>
          <div class="flex justify-center items-center whitespace-nowrap mt-10 lg:mt-0">
            <%= button_tag '▼ 全選択', type: 'button', id: 'select-all', class: 'rounded bg-lime-200 px-4 py-2 m-1' %>
            <%= button_tag '▽ 全解除', type: 'button', id: 'deselect-all', class: 'rounded bg-red-200 px-4 py-2 m-1' %>
          </div>
        </div>
      </div>
    </div>
    <div class="form-group justify-center" id="tasks-container">
      <%= f.fields_for :tasks, @tasks do |task| %>
        <%= render 'task_fields', f: task %>
      <% end %>
    </div>
    <div class="flex justify-center p-8">
      <%= link_to_add_association raw('<i class="fa-solid fa-circle-plus"></i> 追加'), f, :tasks, class:"bg-lime-300 py-3 p-6 rounded-lg" %>
    </div>

    <div class="flex flex-col sm:flex-row justify-center md:p-8 whitespace-nowrap">
      <button class="bg-gray-500 py-3 px-4 rounded-lg text-white m-3" type="button" id="sort-tasks-button"><i class="fa-solid fa-arrow-right-arrow-left fa-rotate-90"></i> 時間順に並び替える</button>
      <button class="bg-blue-400 py-3 px-4 rounded-lg text-white m-3" type="submit"><i class="fa-solid fa-check"></i> スケジュールを保存する</button>
    </div>
  <% end %>
</main>
<script>
  document.getElementById('select-all').addEventListener('click', function() {
    var checkboxes = document.querySelectorAll('input[type=checkbox]');
    for (var i = 0; i < checkboxes.length; i++) {
      if (checkboxes[i].id != 'schedule_tasks_attributes_0_goal_select') {
        checkboxes[i].checked = true;
      }
    }
  });
  document.getElementById('deselect-all').addEventListener('click', function() {
    var checkboxes = document.querySelectorAll('input[type=checkbox]');
    for (var i = 0; i < checkboxes.length; i++) {
      if (checkboxes[i].id != 'schedule_tasks_attributes_0_goal_select') {
        checkboxes[i].checked = false;
      }
    }
  });

  document.getElementById('sort-tasks-button').addEventListener('click', function() {
    // タスクのフォームフィールドを時間順に並び替え
    var sortedTasks = Array.from(document.querySelectorAll('.nested-fields')).sort(function(a, b) {
      var timeA = a.querySelector('select[name$="[task_time(4i)]"]').value + ':' + a.querySelector('select[name$="[task_time(5i)]"]').value;
      var timeB = b.querySelector('select[name$="[task_time(4i)]"]').value + ':' + b.querySelector('select[name$="[task_time(5i)]"]').value;
      return timeA > timeB ? 1 : -1;
    });

    // 並び替えたタスクのフォームフィールドを挿入
    var tasksContainer = document.getElementById('tasks-container');
    sortedTasks.forEach(function(taskFields) {
      tasksContainer.appendChild(taskFields);
    });
  });
</script>

<script>
// $(document).ready(function() {
//   $(document).on('cocoon:after-insert', function(e, insertedItem) {
//     $(".task").sortable();
//     $(".task").sortable('refresh');
//   });
// });
</script>

<!--jQueryを読み込み-->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<!--jQuery UIを読み込み-->
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">